#!/usr/bin/env bash

## #ddev-generated: If you want to edit and own this file, remove this line.
## Description: Support for opening databases in DataGrip
## Usage: datagrip
## Example: "ddev datagrip" or "ddev datagrip --database database2" to open a database named "database2"
## Flags: [{"Name":"database","Shorthand":"d","Usage":"Database name"},{"Name":"reset","Shorthand":"r","Usage":"Reset DataGrip datasource. Manual refresh in DataGrip is required after launch"},{"Name":"auto-refresh","Shorthand":"a","Usage":"Sets the interval, in minutes, that DataGrip will refresh the datasource. Minimum 0.1 minute (6 seconds). Set to 0 to disable"},{"Name":"pg-pass","Shorthand":"p","Usage":"Allows projects using Postgres to utilize the .pgpass file instead of storing credentials in the project directory. Passing this argument is required EACH TIME the command is run. While these credentials are still well known and inherently safe to store, using .pgpass may be beneficial, such as organizations that perform scans on commits for credentials."}]
## DBTypes: mariadb,mysql,postgres

RESET=false
DATABASE="db"
AUTOREFRESH=1
PGPASS=false

PGPASS_FILE="$HOME/.pgpass"

# DDEV_DATABASE is in the format type:version, like mysql:8 or mariadb:10.6. This gets the type part (mysql or mariadb)
DB_TYPE="${DDEV_DATABASE%%:*}"

while :; do
  case ${1:-} in
  -d|--database)
      echo "üîé --database flag provided, setting database to $2"
      DATABASE="$2"
      shift # Extra shift for the argument value
      ;;
  -r|--reset)
    echo "üß® --reset flag provided, resetting DataGrip datasource"
    RESET=true
    ;;
  -a|--auto-refresh)
    echo "üîÑ --auto-refresh flag provided, setting auto-refresh interval to $2"
    AUTOREFRESH=$2
    if [[ ! "$AUTOREFRESH" =~ ^[0-9]+\.?[0-9]*$ ]]; then
      echo "‚ùå Error: auto-refresh value '$AUTOREFRESH' is not a valid number"
      exit 1
    fi
    if (( $(echo "$AUTOREFRESH < 0.1" | bc -l) )); then
      if (( $(echo "$AUTOREFRESH <= 0" | bc -l) )); then
        echo "üõë Auto-refresh set to 0, disabling"
      else
        echo "‚ö†Ô∏è Provided auto-refresh interval of $AUTOREFRESH is less than 0.1. Clamping to 0.1 minutes (6 seconds)"
        AUTOREFRESH=0.1
      fi
    fi
    shift # Extra shift for the argument value
    ;;
  -p|--pg-pass)
    if [[ "$DB_TYPE" != "postgres" ]]; then
      echo "‚ö†Ô∏è --pg-pass cannot be used without a Postgres DB. This project is using $DB_TYPE, so --pg-pass will not affect anything"
    else
      echo "üîÑ --pg-pass flag provided, using .pgpass for authentication in DataGrip"
      echo "‚ö†Ô∏è Note that using --pg-pass is a potentially destructive action as it writes to your .pgpass file. This should be safe, but be sure to back up your file, anyway."
      if [[ -f "$PGPASS_FILE" && ! -f "$PGPASS_FILE.bak" ]]; then
        echo "‚ö†Ô∏è As this is the first time --pg-pass has been used, ~/.pgpass.bak file has be created for you as a precaution, which contains the pre-datagrip configuration (if any)"
        cp -p "$PGPASS_FILE" "$PGPASS_FILE.bak"
      fi
      PGPASS=true
    fi
    ;;
  --) # End of all options.
    shift
    break
    ;;
  -?*)
    printf 'WARN: Unknown option (ignored): %s\n' "$1" >&2
    ;;
  *) # Default case: No more options, so break out of the loop.
    break ;;
  esac

  shift
done

# Make sure the project is running; if not, start it and re-run this via ddev
if [ "${DDEV_PROJECT_STATUS}" != "running" ] && [ -z "${no_recursion:-}" ]; then
  echo "‚ùå Project ${DDEV_PROJECT} is not running, starting it"
  ddev start
  start_exit_code=$?
  if [ $start_exit_code -ne 0 ]; then
    exit $start_exit_code
  fi
  # run this script again, as the environment is updated after "ddev start"
  no_recursion=true ddev "$(basename "$0")" "$@"
  exit $?
fi

echo "‚úÖ Project ${DDEV_PROJECT} is running!"
echo "üîÑ Preparing DataGrip datasource..."

# Check for first-run or reset for proper messaging later on
if [[ ! -d "${DDEV_APPROOT}/.ddev/datagrip/.idea/dataSources" ]]; then
  FIRST_RUN=true
elif [[ "$RESET" == true ]]; then
  rm -rf "${DDEV_APPROOT}/.ddev/datagrip/.idea"
  mkdir -p "${DDEV_APPROOT}/.ddev/datagrip/.idea"
fi

# Build the JDBC URL based on DDEV env vars
if [[ "$DB_TYPE" == "mysql" ]]; then
  echo "üîé Configuring DataGrip for MySQL"
  query="jdbc:mysql://${DDEV_PROJECT}.${DDEV_TLD}:${DDEV_HOST_DB_PORT}/${DATABASE}?user=db&amp;password=db"
  driverRef="mysql.8"
  jdbcDriver="com.mysql.cj.jdbc.Driver"
elif [[ "$DB_TYPE" == "mariadb" ]]; then
  echo "üîé MariaDB database detected, selecting MariaDB JDBC driver for better compatibility"
  query="jdbc:mariadb://${DDEV_PROJECT}.${DDEV_TLD}:${DDEV_HOST_DB_PORT}/${DATABASE}?user=db&amp;password=db"
  driverRef="mariadb"
  jdbcDriver="org.mariadb.jdbc.Driver"
elif [[ "$DB_TYPE" == "postgres" ]]; then
  echo "üîé Configuring DataGrip for Postgres"
  if [[ "$PGPASS" == true ]]; then
    query="jdbc:postgresql://${DDEV_PROJECT}.${DDEV_TLD}:${DDEV_HOST_DB_PORT}/${DATABASE}"

    CREDS="${DDEV_PROJECT}.${DDEV_TLD}:${DDEV_HOST_DB_PORT}:${DATABASE}:db:db"
    PATTERN="^.*:[0-9]+:${DATABASE}:db:.*$"

    tmp="$(mktemp "${PGPASS_FILE}.XXXXXX")"

    # Ensure file exists so awk can read it
    touch "$PGPASS_FILE"

    awk -v pat="$PATTERN" -v repl="$CREDS" '
      BEGIN { replaced=0 }
      $0 ~ pat { print repl; replaced=1; next }
      { print }
      END { if (!replaced) print repl }
    ' "$PGPASS_FILE" > "$tmp" && mv "$tmp" "$PGPASS_FILE"

    chmod 600 "$PGPASS_FILE"
  else
    query="jdbc:postgresql://${DDEV_PROJECT}.${DDEV_TLD}:${DDEV_HOST_DB_PORT}/${DATABASE}?user=db&amp;password=db"
  fi

  driverRef="postgresql"
  jdbcDriver="org.postgresql.Driver"
else
  echo "‚ùå Unsupported database type: ${DB_TYPE}"
  exit 1
fi

# Where to put the DataGrip config
IDEA_DIR="${DDEV_APPROOT}/.ddev/datagrip/.idea"
DATASOURCES_FILE="${IDEA_DIR}/dataSources.xml"
DATASOURCES_LOCAL_FILE="${IDEA_DIR}/dataSources.local.xml"

# UUID for the datasource, necessary to remain static to avoid a "refresh" on each launch
uuid_value="d0c53247-ec9f-44c8-9f4c-ea8f03b67892"

# Write the XML file, interpolating Bash variables like $query
cat > "$DATASOURCES_FILE" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="DataSourceManagerImpl" format="xml" multifile-model="true">
    <data-source source="LOCAL" name="ddev" uuid="${uuid_value}">
      <driver-ref>${driverRef}</driver-ref>
      <synchronize>true</synchronize>
      <configured-by-url>true</configured-by-url>
      <jdbc-driver>${jdbcDriver}</jdbc-driver>
      <jdbc-url>${query}</jdbc-url>
      <jdbc-additional-properties>
        $(if [[ "${AUTOREFRESH}" != "0" ]]; then echo "<property name=\"auto-refresh-interval\" value=\"${AUTOREFRESH}\" />"; fi)
      </jdbc-additional-properties>
      <driver-properties>
        <property name="autoReconnect" value="true" />
      </driver-properties>
      <working-dir>\$ProjectFileDir\$</working-dir>
    </data-source>
  </component>
</project>
EOF

# Build node block
if [[ "$DB_TYPE" == "postgres" ]]; then
  NODE_BLOCK="<node kind=\"database\" qname=\"@\">
    <node kind=\"schema\" qname=\"@\" />
  </node>
  <node kind=\"database\" qname=\"${DATABASE}\">
    <node kind=\"schema\" qname=\"public\" />
  </node>"
else
  NODE_BLOCK="<node kind=\"schema\">
    <name qname=\"@\" />
    <name qname=\"${DATABASE}\" />
  </node>"
fi

# Build auth block (only when using pgpass)
if [[ "$PGPASS" == true ]]; then
  AUTH_BLOCK="<auth-provider>pgpass</auth-provider>
  <user-name>db</user-name>"
else
  AUTH_BLOCK=""
fi

# Write the XML for the dataSources.local.xml file. This may change depending on PGPASS, so we rewrite it each time now.
cat > "$DATASOURCES_LOCAL_FILE" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
<component name="dataSourceStorageLocal">
  <data-source name="ddev" uuid="${uuid_value}">
    ${AUTH_BLOCK}
    <schema-mapping>
      <introspection-scope>
        ${NODE_BLOCK}
      </introspection-scope>
    </schema-mapping>
    <introspection-level>3</introspection-level>
  </data-source>
</component>
</project>
EOF

echo "‚úèÔ∏è Wrote DataGrip datasource, starting datagrip..."

if [[ "$FIRST_RUN" == true ]]; then
  echo -e "\\a" # Beep for attention
  COLUMNS=$(tput cols) 
  echo ""
  title="‚ö†Ô∏è No schema for the DB has been detected ‚ö†Ô∏è" 
  printf "%*s\n" $(((${#title}+$COLUMNS)/2)) "$title"
  printf "%*s" "$COLUMNS" | tr ' ' '-'
  echo "If this is your first time connecting to the DB, no schema has been generated."
  echo "Due to DataGrip limitations, you must manually refresh the datasource in DataGrip to generate the schema"
  echo "You should not need to manually refresh again unless you manually delete the project or datasource, or run 'ddev datagrip --reset'"
  printf "%*s" "$COLUMNS" | tr ' ' '-'
  echo ""
elif [[ "$RESET" == true ]]; then
  echo -e "\\a" # Beep for attention
  COLUMNS=$(tput cols) 
  echo ""
  title="‚ö†Ô∏è DataGrip datasource has been reset ‚ö†Ô∏è" 
  printf "%*s\n" $(((${#title}+$COLUMNS)/2)) "$title"
  printf "%*s" "$COLUMNS" | tr ' ' '-'
  echo "DataGrip datasource has been reset. You must manually refresh the datasource in DataGrip."
  echo "You should not need to manually refresh again unless you manually delete the project or datasource, or run 'ddev datagrip --reset'"
  printf "%*s" "$COLUMNS" | tr ' ' '-'
  echo ""
fi

datagrip "${DDEV_APPROOT}/.ddev/datagrip"